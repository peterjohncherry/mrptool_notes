Begin by defining a space $\mathrm{s}$, split into a reference, $\mathrm{p}$, and external, $\mathbf{q}$, space;
\begin{equation}
\mathrm{s} = \mathrm{p} + \mathrm{s} = \{ |p\rangle \} \cup \{|q\rangle \}
\end{equation}
Now define projection operators
\begin{equation}
\hat{P} =\sum_{p} |p\rangle \langle p | 
\text{ \ \ \ \ \ \ \ \ \ }
\hat{Q} =\sum_{q} |q\rangle \langle q | 
\end{equation}
\begin{equation}
\hat{P}+\hat{Q} = \hat{I}
\text{\ \ \ \ \ \ \ \ \ }
\hat{P}-\hat{I} = \hat{Q}
\end{equation}
Then have zeroth order Hamiltonian, $\hat{H}_{0}$, and perturbation, $\hat{V}$. The spaces $\mathrm{p}$ and $\mathrm{q}$ are such that
\begin{equation}
\langle p | \hat{H}_{0} | q \rangle  = 
\langle q | \hat{H}_{0} | p \rangle  = 
\langle p | \hat{V} | p \rangle  =  0 \text{ \ \ \ } \forall \text{ \ }p\text{,\ }q  . 
\label{eqn:space_props}
\end{equation}
Write two equations for the zeroth order, $\hat{H}_{0}$, and full, $\hat{H} = \hat{H}_{0} + \hat{V}$, Hamiltonians:
\begin{equation}
\hat{H}_{0} | p \rangle  = \epsilon_{p} |p \rangle
\end{equation}
\begin{equation}
\hat{H}|\Psi_{p} \rangle =( \hat{H}_{0}+\hat{V} )| \Psi_{p} \rangle  = (\epsilon_{p}+E_{p})|\Psi_{p} \rangle
\end{equation}
Here, $|\Psi_{p}\rangle$, is being treated as though it were a perturbation of state $|p\rangle$. Initially, 
assume that there is only one state in the space $\mathrm{p}$. It is now more convenient to write this as
\begin{equation}
(\epsilon_{p}-\hat{H}_{0} )| \Psi_{p} \rangle  = (\hat{V}-E_{p})|\Psi_{p} \rangle
\end{equation}
The wavefunction $|\Psi_{p} \rangle$ may be expanded in $\mathrm{p}$ and $\mathrm{q}$;
\begin{equation}
| \Psi_{p} \rangle  = \sum_{p} C_{p}|p\rangle + \sum_{q} T_{q}|q\rangle.
\end{equation}
Hence,
\begin{equation}
\hat{P} | \Psi_{p} \rangle  = \sum_{p} C_{p}|p\rangle
\text{ \ \ \ \  and \ \ \ \ }
\hat{Q} | \Psi_{p} \rangle  = \sum_{q} T_{q}|q\rangle .
\end{equation}
This, combined with the identities associated with the projectors $\hat{P}$ and $\hat{Q}$, and the
attributes of the space, $\mathrm{s}$, stated in (\ref{eqn:space_props}) leads to the following statement
\begin{equation}
\hat{P}(\epsilon_{p} - \hat{H}_{0})(\hat{P}+\hat{Q})| \Psi_{p} \rangle  =  \hat{P}(\hat{V}-E_{p})(\hat{P}+\hat{Q})|\Psi_{p} \rangle .
\label{eqn:P_on_both sides}
\end{equation}
Taking each side separately:
\begin{equation}
\hat{P}(\epsilon_{p} - \hat{H}_{0})(\hat{P}+\hat{Q})| \Psi_{p} \rangle  = 0  ,
\label{eqn:P_on_EH}
\end{equation}
\begin{equation}
\hat{P}(\hat{V}-E_{p})(\hat{P}+\hat{Q})|\Psi_{p} \rangle = \hat{P}\hat{V}\hat{Q}|\Psi_{p} \rangle + \hat{Q}E_{p}\hat{Q}|\Psi_{p}\rangle .
\label{eqn:P_on_VE}
\end{equation}
Substituting (\ref{eqn:P_on_EH}) and (\ref{eqn:P_on_VE}) back into (\ref{eqn:P_on_both sides}) and rearranging we obtain
\begin{equation}
\hat{P}\hat{V}\hat{Q}|\Psi_{p} \rangle =  \hat{P}E_{p}\hat{P}|\Psi_{p}\rangle .
\label{eqn:pt_energy}
\end{equation}
Assuming the members of $\mathrm{p}$ are orthonormal and taking advantage of the consequent idempotency of $\hat{P}$ leads to
\begin{equation}
\hat{P}E_{p}\hat{P}|\Psi_{p}\rangle = E_{p}\hat{P}|\Psi_{p} \rangle ,
\end{equation}
hence
\begin{equation}
\sum_{p'} \langle p' | E_{p}\hat{P}|\Psi_{p} \rangle  =  \sum_{p'} \langle p' | \hat{V}\hat{Q}|\Psi_{p} \rangle.
\label{eqn:multistate_pt_energy}
\end{equation}
Whilst the primary intention of the MRPTool module is to tackle multistate, highly degenerate cases, it helpful\footnote{for me, at least} 
to first consider the singlestate case, i.e., where the dimension of $\mathrm{p}$ is 1. 
If intermediate normalization, $\langle p | \Psi_{p} \rangle = 1$, is assumed then 
\begin{equation}
\hat{P}E_{p}\hat{P}|\Psi_{p}\rangle = E_{p},
\end{equation}
which leads to 
\begin{equation}
E_{p} = \langle p | \hat{V}\hat{Q}|\Psi_{p} \rangle.
\label{eqn:singlestate_pt_energy}
\end{equation}
If in (\ref{eqn:P_on_both sides}) $\hat{Q}$ instead of $\hat{P}$ was applied from the left the following expressions would result:
\begin{equation}
\hat{Q}(\hat{V}-E_{p})(\hat{P}+\hat{Q})|\Psi_{p} \rangle = \hat{Q}\hat{V}|\Psi_{p} \rangle - \hat{Q}E_{p}\hat{Q}|\Psi_{p}\rangle ,
\label{eqn:Q_on_VE}
\end{equation}
\begin{equation}
\hat{Q}(\epsilon - \hat{H}_{0})(\hat{P}+\hat{Q})| \Psi_{p} \rangle  = \hat{Q}\epsilon_{p}\hat{Q}|\Psi\rangle- \hat{Q}\hat{H}_{0}\hat{Q}|\Psi_{p}\rangle.
\end{equation}
However, noting that the RHS of (\ref{eqn:P_on_EH}) is $0$ it is possible to write
\begin{equation*}
\hat{Q}(\epsilon_{p} - \hat{H}_{0})(\hat{P}+\hat{Q})| \Psi_{p} \rangle =
(\hat{P} + \hat{Q})(\epsilon_{p} - \hat{H}_{0})(\hat{P}+\hat{Q})| \Psi_{p} \rangle =
(\epsilon_{p} - \hat{H}_{0})| \Psi_{p} \rangle ,
\end{equation*}
hence
\begin{equation}
(\epsilon - \hat{H}_{0})| \Psi_{p} \rangle  = \hat{Q}\epsilon_{p}\hat{Q}|\Psi\rangle- \hat{Q}\hat{H}_{0}\hat{Q}|\Psi_{p}\rangle.
\label{eqn:Q_on_EH} 
\end{equation}
Equating the RHS's of (\ref{eqn:Q_on_EH}) and (\ref{eqn:Q_on_VE})
 \begin{equation*}
(\epsilon_{p} - \hat{H}_{0})|\Psi_{p}\rangle
= \hat{Q}\hat{V}|\Psi_{p} \rangle - \hat{Q}E_{p}\hat{Q}|\Psi_{p}\rangle .
\end{equation*}
If there is only one state in $\mathrm{p}$, then it is possible to substitute in from  (\ref{eqn:singlestate_pt_energy}) to obtain
\begin{equation*}
( \epsilon_{p}- \hat{H}_{0} )|\Psi_{p}\rangle = 
\hat{Q}\hat{V}|\Psi_{p} \rangle - \hat{Q}[\langle p | \hat{V}\hat{Q}|\Psi_{p} \rangle] \hat{Q}|\Psi_{p}\rangle, 
\end{equation*}
noting that  $[\langle p | \hat{V}\hat{Q}|\Psi_{p} \rangle] = [\langle p | \hat{V} |\Psi_{p} \rangle]$, which
is just a number, and that $Q$ is idempotent, this can be rewritten
\begin{equation}
( \epsilon_{p}- \hat{H}_{0} )|\Psi_{p}\rangle = 
\hat{Q}\hat{V}|\Psi_{p} \rangle -  \hat{Q}|\Psi_{p}\rangle[\langle p | \hat{V} |\Psi_{p} \rangle]. 
\label{eqn:Q_on_both_sides_singlestate}
\end{equation}
It is useful to define a "wave operator" $\hat{\Omega}^{p}$ which can be used to obtain the perturbed state, $|\Psi_{p}\rangle$,
from a state $\{ |p\rangle \}$ within the reference space $\mathrm{p}$;
\begin{equation}
|\Psi_{p} \rangle = \hat{\Omega}_{p}|p\rangle .
\end{equation}
This may be used to rewrite (\ref{eqn:Q_on_both_sides_singlestate}) as 
\begin{equation}
( \epsilon_{p}- \hat{H}_{0} )\hat{\Omega}^{p}|p\rangle = 
\hat{Q}\hat{V}\hat{\Omega}^{p}|p \rangle -  \hat{Q}\hat{\Omega}^{p}|p\rangle[\langle p | \hat{V}\hat{\Omega}^{p} |p \rangle]. 
\label{eqn:BlochSingleState}
\end{equation}
CASPT2 and related theories discussed in the following can be thought of as techniques for finding approximate methods for finding $\Omega_{p}$. 

\section{ CASPT2 }
\noindent The wave operator can be written as a series expansion;
\begin{equation}
\hat{\Omega}^{p} = \hat{\Omega}^{p,0}+\hat{\Omega}^{p,1}+\hat{\Omega}^{p,2}+....
\end{equation} 
where 
\begin{equation}
\hat{\Omega}^{p,0}|p\rangle = |p^{0}\rangle = |p\rangle \text{, \ \  }
\hat{\Omega}^{p,1}|p\rangle = |p^{1}\rangle \text{, \ \ }
\hat{\Omega}^{p,2}|p\rangle = |p^{2}\rangle \text{, \  etc.. }
\label{eqn:wave_op_series}
\end{equation} 
Where  $\langle p^{i} | p^{j} \rangle=  \delta_{ij}$,  hence $(\hat{Q}\hat{\Omega}^{p,0}) = 0$.
Expanding out the energy in a similar manner,
substituting the above expansion into (\ref{eqn:BlochSingleState}) and equating first order terms leads to the first order
wave equation,
\begin{equation}
(\epsilon_{p} - \hat{H}_{0} )\Omega^{p,1}|p\rangle = \hat{Q}\hat{H}|p\rangle ,
\label{eqn:Bloch_singlestate_firstorder}
\end{equation}
which makes use of the fact that $ \hat{Q}\hat{V}|p\rangle= \hat{Q}\hat{H}|p\rangle$. A similar logic may be
used to obtain an expression for the second order energy;
\begin{equation}
E_{p}^{(2)} = E_{p}^{(1)} + \langle p | \hat{H} \hat{\Omega}^{p,1}| p \rangle .
\label{eqn:single_state_ptE_second_order}
\end{equation}
Provided the above orthogonality constraints are met there is considerable freedom in choosing the form of the terms in the
series $(\ref{eqn:wave_op_series})$.  A natural choice is to have $\hat{\Omega}^{p,1}$, be the contribution
to $|\Psi_{p}\rangle$ from single and doubly excited states, $\hat{\Omega}^{p,2}$,  the contribution from triply
and quadruply excited states, and so on:
\begin{equation*}
\hat{\Omega}^{p,0} = \sum_{m} |m \rangle \langle m |   \text{, \ \ \  } m \in \mathrm{p}
\end{equation*}
\begin{equation*}
\hat{\Omega}^{p,1} = \sum_{r}| r \rangle \langle p | T^{p}_{r} \text{ \ \ \ } r \in \mathrm{q}^{sd} 
\end{equation*}
\begin{equation*}
\hat{\Omega}^{p,2} = \sum_{x}| x \rangle \langle p | T^{p}_{x} \text{ \ \ \ } x \in \mathrm{q}^{tq}  \text{, \  etc.. }.
\end{equation*}
The above makes use of the fact that the space, $q$, may be split up into mutually orthogonal 
subspaces corresponding to singly and doubly excited states, triply and quadruply excited states, etc..,
\begin{equation}
\mathrm{q} = \mathrm{q}^{sd} + \mathrm{q}^{tq} + ...
\end{equation}
The $T^{p}_{r}$ are amplitude coefficients indicating how much $|r\rangle \in q^{(st)}$
contributes to $|\Psi_{p}\rangle$.\\

\noindent In the internally contracted framework projection into these excited spaces is achieved via excitation operators, e.g., $\hat{E}_{\omega}$,
which excite the appropriate number of electrons from the closed or active orbitals specified by $\omega$; 
\begin{equation}
\hat{E}^{sd}_{\omega}|p\rangle = |r_{p}\rangle  \text{ \ \ \ \ } |r\rangle \in q^{sd} .
\end{equation}
Note that the state onto which the operator $\hat{E}^{sd}_{\omega}$ projects is dependent on
the state $|p\rangle $  upon which it acts. So in principal, it is possible to replace the index denoting 
orbital excitations with a subscripted index, $\omega_{p}$, where $\omega_{p}$ is the state onto which
the action of $\hat{E}_{\omega}$ on $|p\rangle$ projects, i.e.,
\begin{equation}
\hat{E}_{\omega} |p\rangle \rightarrow 
\hat{E}_{r_{p}} |p\rangle = | r_{p} \rangle \langle p | p \rangle .
\end{equation}
Though needlessly prolix when the subspace $\mathrm{p}$ contains only one state, this notation will
come in use later on when dealing with the multistate case. However, until that point, the subscript on $p$
shall be omitted.\\

\noindent Rewriting (\ref{eqn:Bloch_singlestate_firstorder}) using these definitions gives
\begin{equation}
\sum_{r'}(\epsilon_{p} - \hat{H}_{0} )T_{r'}^{st} \Omega^{p,1}|p\rangle = \sum_{r}\hat{Q}^{st}_{r}\hat{H}|p\rangle .
\label{eqn:Bloch_singlestate_firstorder_st}
\end{equation}
\begin{equation*}
\sum_{r}^{r\in q^{st}} (\epsilon_{p} - \hat{H}_{0} )T_{r}^{p} \hat{E}_{r} | p \rangle 
= 
\sum_{r}^{r\in q^{st}} |r \rangle \langle r | \hat{H}|p\rangle .
\end{equation*}
Rearranging and left multiplying by $\langle r | \in q^{st}$ gives  
\begin{equation*}
\langle r' | \sum_{r}^{r\in q^{st}} (\epsilon_{p} - \hat{H}_{0} )T_{r}^{p} | r \rangle 
-
\langle r' | \sum_{r}^{r\in q^{st}} | r \rangle \langle r | \hat{H} |p\rangle = 0
\end{equation*}
\begin{equation}
\langle r' | \sum_{r}^{r\in q^{st}} (\epsilon_{p} - \hat{H}_{0} )T_{r}^{p} | r \rangle 
-
\langle r' | \hat{H} |p\rangle = 0
\label{eqn:Amplitude_eqn}
\end{equation}
The derivative with respect $T$ should vanish, so at convergence,
\begin{equation}
\sum_{r}^{r\in q^{st}} \langle r' |(\epsilon_{p} - \hat{H}_{0} )T_{r}^{p} | r \rangle = G = 0 
\label{eqn:caspt2_residual}
\end{equation}
Using the definition of the functional derivative;
\begin{equation*}
\frac{G[T_{r}^{p} + \delta T ] - G[T_{r}^{p}]}{ \delta T_{r}^{p} } = 0,
\end{equation*}
\begin{equation}
\frac{\delta G[T^{p}_{r}]} { \delta T^{p}_{r}}  = 
\langle r |(\epsilon_{p} - \hat{H}_{0} )| r \rangle.
\end{equation}
This can now be used to obtain the T update equation
\begin{equation}
\Delta T_{r} = \Bigg{(}\frac{\delta G[T^{p}_{r}]} { \delta T^{p}_{r}}\Bigg{)}^{-1}G[T^{p}_{r}]  = 
\frac{\sum_{r}^{r\in q^{st}} \langle r' |(\epsilon_{p} - \hat{H}_{0} )T_{r}^{p} | r \rangle} 
{\langle r' |(\epsilon_{p} - \hat{H}_{0} )| r' \rangle}.
\label{eqn:T_update}
\end{equation}
This expression is iterated over until the threshold is reached. 

\section{ Multistate cases }
\noindent As mentioned above, the case where $\mathrm{p}$ contains more than one state is less straightforward, and there
a number of approaches to dealing with it (MS-CASPT2, XMS-CASPT2, GVVPT2 etc., ).  To explain the issues associated with the
degenerate multistate case, and to illustrate the different in motivation and structure of these approaches,
the above expressions are now rewritten using an explicit basis for spaces $\mathrm{p}$ and $\mathrm{q}$:
\begin{equation*}
\hat{P} =\sum_{p} | p \rangle \langle p |  \text{\ \ \ \ \ }
\hat{Q} =\sum_{q} | q \rangle \langle q | ,
\end{equation*}
\begin{equation*}
\hat{P}|\Psi_{p}\rangle =\sum_{p}\sum_{l} | p \rangle \langle p | l \rangle X_{l}^{p}
\text{ \ \ \ \ \ \ }
\hat{Q}|\Psi_{p}\rangle =\sum_{q}\sum_{r} | q \rangle \langle q | r \rangle T_{r}^{p},
\end{equation*}
where $X_{l}^{p}$ and $T_{r}^{p}$ are coefficients. The $X_{l}^{p}$ may be interpreted
as the coefficients describing how the perturbation acts to mix together the
states within the reference space, $\mathrm{p}$. If the states within the reference 
space are well separated energetically, then it is reasonable to assume that this
mixing is small, and $X_{l}^{p} \rightarrow \delta_{l}^{p} $, however, this is not the case,
by definition, in the vicinity of conical intersections.\\

\noindent In the following initial discussion of approaches to this problem it shall be assumed that 
the sets of $\{|l\rangle\}$ and $\{|r\rangle\}$ being summed over are identical to the respective sets
$\{|p\rangle\}$ and $\{|q\rangle\}$. This assumption is not valid in the case of internally contracted 
methods, which will be discussed in due course.\\

\noindent Rewriting (\ref{eqn:P_on_EH}) with this basis gives
\begin{equation*}
\sum_{mnl}|m\rangle \langle m | (\epsilon_{p} - \hat{H}_{0})|n\rangle \langle n | l \rangle X_{l}^{p}
+ \sum_{mqr}|m\rangle \langle m | (\epsilon_{p} - \hat{H}_{0})|q\rangle \langle q | r \rangle T_{r}^{p}
\end{equation*}
\begin{equation*}
\sum_{mnl}|m\rangle \langle m | (\epsilon_{p} - \hat{H}_{0})   | l \rangle X_{l}^{p}
+ \sum_{mqr}|m\rangle \langle m | (\epsilon_{p} - \hat{H}_{0}) | r \rangle T_{r}^{p}
\label{eqn:P_on_EH_explicit_bas}
\end{equation*}
Multiplying from the left by state $\langle\Psi_{p}| = \sum_{k}\langle k | X_{k}^{p \ \dagger}$ yields
\begin{equation*}
\sum_{kmnl}X^{p\dagger}_{k}\langle k | m\rangle \langle m | (\epsilon_{p} - \hat{H}_{0})   | l \rangle X_{l}^{p}
+ \sum_{kmqr}X^{p\dagger}_{k}\langle k | (\epsilon_{p} - \hat{H}_{0}) | r \rangle T_{r}^{p}
\end{equation*}
\begin{equation}
=  \sum_{kl}X^{p\dagger}_{k}\langle k | (\epsilon_{p} - \hat{H}_{0}) | l \rangle X_{l}^{p}
\label{eqn:P_on_EH_ms_nondiag}
\end{equation}
The useful expression (\ref{eqn:singlestate_pt_energy}) for the perturbation energy, $E_{p}$, 
may be obtained because the RHS of (\ref{eqn:P_on_EH}), the single state analogue of (\ref{eqn:P_on_EH_ms_nondiag}), vanishes.
Unfortunately, this does not happen here, a fact which will later prove significant.
There is more than one way of handling this issue, but to summarize them properly it is
worth first discussing the generalized Bloch equation.

\section{ Generalized Bloch Equation } 
Consider the matrix equation,
\begin{equation}
\mathbf{H}\boldsymbol{\Psi} =
\begin{bmatrix}
 \mathbf{H_{PP}} & \mathbf{H_{PQ}} \\ 
 \mathbf{H_{QP}} & \mathbf{H_{QQ}} \\ 
\end{bmatrix} 
\begin{bmatrix}
 \boldsymbol{\Psi}_{P} \\ 
 \boldsymbol{\Psi}_{Q} \\ 
\end{bmatrix} 
= E 
\begin{bmatrix}
 \boldsymbol{\Psi}_{P} \\ 
 \boldsymbol{\Psi}_{Q} \\ 
\end{bmatrix} 
\end{equation}
Now introduce a transformation operator, $\mathbf{S}$, which can be used to obtain the full 
vector, $\boldsymbol{\Psi}$, from just the component, $\boldsymbol{\Psi}_{P}$, within the $\mathrm{p}$ subspace, i.e.,
\begin{equation}
\mathbf{S}(\mathbf{T})\boldsymbol{\Psi}_{0}= 
\begin{bmatrix}
\mathbf{I}_{PP} & 0 \\ 
\mathbf{T} & \mathbf{I}_{QQ} \\ 
\end{bmatrix}
\begin{bmatrix}
\boldsymbol{\Psi}_{P} \\ 
0 \\ 
\end{bmatrix}=  
\begin{bmatrix}
\boldsymbol{\Psi}_{P} \\ 
\mathbf{T}\boldsymbol{\Psi}_{P} \\ 
\end{bmatrix} 
= \boldsymbol{\Psi}
\end{equation}
The matrix $\mathbf{S}(\mathbf{T})$ has useful property
\begin{equation}
\mathbf{S}(\mathbf{T}_{1})+ \mathbf{S}(\mathbf{T}_{2})=\mathbf{S}(\mathbf{T}_{1}+\mathbf{T}_{2}),
\end{equation}
which has the corollary  $\mathbf{S}(\mathbf{T})^{-1}=\mathbf{S}(-\mathbf{T})$ . Noting this it is possible to write
\begin{equation}
\mathbf{S}(\mathbf{T})^{-1} \mathbf{H} \mathbf{S}(-\mathbf{T})\boldsymbol{\Psi}_{0} = 
\end{equation}
\begin{equation}
\begin{bmatrix}
\mathbf{I}_{PP} & \mathbf{0} \\ 
-\mathbf{T} & \mathbf{I}_{QQ} \\ 
\end{bmatrix}
\begin{bmatrix}
 \mathbf{H}_{PP} & \mathbf{H}_{PQ} \\ 
 \mathbf{H}_{QP} & \mathbf{H}_{QQ} \\ 
\end{bmatrix} 
\begin{bmatrix}
\mathbf{I}_{PP} & \mathbf{0} \\ 
\mathbf{T} & \mathbf{I}_{QQ} \\ 
\end{bmatrix}
\begin{bmatrix}
 \boldsymbol{\Psi}_{P} \\ 
 \mathbf{0}\\ 
\end{bmatrix} 
= E 
\begin{bmatrix}
 \boldsymbol{\Psi}_{P} \\ 
 \mathbf{0}\\ 
\end{bmatrix} 
\label{eqn:TransEvalEqn}
\end{equation}
The blocks of the transformed matrix $\mathbf{\tilde{H}} = \mathbf{S}(\mathbf{T})^{-1} \mathbf{H} \mathbf{S}(-\mathbf{T})$ are
\begin{equation}
\mathbf{\tilde{H}}_{PP} = \mathbf{H}_{PP} + \mathbf{H}_{PQ}\mathbf{T}
\label{eqn:HPP}
\end{equation} 
\begin{equation}
\mathbf{\tilde{H}}_{PQ} = \mathbf{H}_{PQ}
\end{equation} 
\begin{equation}
\mathbf{\tilde{H}}_{QP} = \mathbf{H}_{QP} + \mathbf{H}_{QQ}\mathbf{T} - \mathbf{\mathbf{H}}_{PP}\mathbf{T} - \mathbf{T}\mathbf{H}_{PQ}\mathbf{T}
\label{eqn:HQP}
\end{equation} 
\begin{equation}
\mathbf{\tilde{H}}_{QQ} = \mathbf{H}_{QQ} -\mathbf{T}\mathbf{H}_{PQ}
\end{equation} 

\noindent The expression (\ref{eqn:HPP}) defines the effective Bloch Hamiltonian, and can be directly connected to the Bloch equation
specified in (\ref{eqn:BlochSingleState}). Requiring that $\mathbf{T}$ is such that (\ref{eqn:HQP}) is zero will decouple the
$H_{PP}$ block rest of the blocks of the transformed matrix, enabling the obtain eigenvalues associated with the $PP$ block to be obtained
separately from those associated with the rest of the matrix;
\begin{equation}
\mathbf{\tilde{H}}
\begin{bmatrix}
 \boldsymbol{\psi_{P}} \\ 
 \mathbf{0} \\ 
\end{bmatrix}
=
\begin{bmatrix}
 \mathbf{\tilde{H}_{PP}} & \mathbf{\tilde{H}_{PQ}} \\ 
 0                       & \mathbf{\tilde{H}_{QQ}} \\ 
\end{bmatrix} 
\begin{bmatrix}
 \boldsymbol{\Psi_{P}} \\ 
 \mathbf{0} \\ 
\end{bmatrix} 
= E 
\begin{bmatrix}
\boldsymbol{\Psi_{P}} \\ 
\mathbf{0} 
\end{bmatrix}.
\label{eqn:TransEvalEqnSimple}
\end{equation}
This can now be connected to the Bloch equation stated earlier by making use of the notation;
\begin{equation}
\mathbf{P} =  
\begin{bmatrix}
\mathbf{I} & \mathbf{0} \\ 
\mathbf{0} & \mathbf{0} 
\end{bmatrix},
\text{ \ \ \ }
\mathbf{Q} =  
\begin{bmatrix}
\mathbf{0} & \mathbf{0} \\ 
\mathbf{0} & \mathbf{I} 
\end{bmatrix},
\text{ \ \ \ }
\boldsymbol{\Omega} =  
\begin{bmatrix}
\mathbf{I} & \mathbf{0} \\ 
\mathbf{F} & \mathbf{0} 
\end{bmatrix},
\text{ \ \ \ }
\boldsymbol{\Psi}^{0} =
\begin{bmatrix}
\boldsymbol{\Psi}_{P} \\
\mathbf{0} 
\end{bmatrix},
\end{equation}

Using this notation the Bloch Hamiltonian, $\mathbf{H}^{Bloch}$, may be written
\begin{equation}
\mathbf{H}^{Bloch} = \mathbf{P}\mathbf{H}\boldsymbol{\Omega}\mathbf{P}\mathbf{\Psi}.
\label{eqn:effective_Bloch}
\end{equation}
As stated earlier, if $\mathbf{T}$, and hence $\boldsymbol{\Omega}$, is defined such that (\ref{eqn:HQP}) vanishes,
then the eigenvalues of this effective Hamiltonian will be a subset of the eigenvalues of the full Hamiltonian. 
It is worth highlighting the identity $\boldsymbol{\Omega}\mathbf{P} = \boldsymbol{\Omega}$, i.e., 
the wave-operator $\Omega$ ensures that the effective Hamiltonian only acts on the components of states which are 
within the $\mathrm{p}$ subspace. \\

\noindent This effective Hamiltonian is the main workhorse of the multireference perturbation theories, but it is worth
continuing with some further analysis and discussion of the Bloch equation so as to facilitate later
discussions of approximate methods. The generalized Bloch equation is  
\begin{equation}
\boldsymbol{\Omega}\mathbf{H}\boldsymbol{\Omega} =
\mathbf{H}\boldsymbol{\Omega}
\label{eqn:GeneralizedBloch}
\end{equation}
To see this more directly it can be written out using the matrices specified above;
\begin{equation*}
=
\begin{bmatrix}
\mathbf{1} & \mathbf{0} \\ 
\mathbf{T} & \mathbf{0} \\ 
\end{bmatrix}
\begin{bmatrix}
 \mathbf{H}_{PP} & \mathbf{H}_{PQ} \\ 
 \mathbf{H}_{QP} & \mathbf{H}_{QQ} \\ 
\end{bmatrix}
\begin{bmatrix}
\mathbf{1} & \mathbf{0} \\ 
\mathbf{T} & \mathbf{0} \\ 
\end{bmatrix}
=
\begin{bmatrix}
 \mathbf{H}_{PP} & \mathbf{H}_{PQ} \\ 
 \mathbf{H}_{QP} & \mathbf{H}_{QQ} \\ 
\end{bmatrix}
\begin{bmatrix}
\mathbf{1} & \mathbf{0} \\ 
\mathbf{T} & \mathbf{0} \\ 
\end{bmatrix}
\end{equation*}
\begin{equation*}
\begin{bmatrix}
 \mathbf{H}_{PP} + \mathbf{H}_{PQ}\mathbf{T}& \mathbf{0} \\ 
 \mathbf{T}\mathbf{H}_{PP} + \mathbf{T}\mathbf{H}_{PQ}\mathbf{T}& \mathbf{0} \\ 
\end{bmatrix}
=
\begin{bmatrix}
 \mathbf{H}_{PP} + \mathbf{H}_{PQ}\mathbf{T} & \mathbf{0} \\ 
 \mathbf{H}_{QP} + \mathbf{H}_{QQ}\mathbf{T} & \mathbf{0} \\ 
\end{bmatrix}
\label{eqn:BlochGenMat}
\end{equation*}
to see that the last two lines are equivalent note use the fact that $\mathbf{T}$ is such that $\tilde{\mathbf{H}}_{QP}$ 
as defined in (\ref{eqn:HQP}) vanishes. Rearranging (\ref{eqn:HQP}) yields 
\begin{equation*}
\mathbf{H}_{QP} + \mathbf{H}_{QQ}\mathbf{T} = \mathbf{\mathbf{H}}_{PP}\mathbf{T} + \mathbf{T}\mathbf{H}_{PQ}\mathbf{T}.
\label{eqn:Tcondition}
\end{equation*}
Hence the two sides of (\ref{eqn:BlochGenMat}) are equivalent. It should be noted that it is in the 
failure of the choice of $\mathbf{T}$ to satisfy the condition specified in (\ref{eqn:Tcondition}) 
that many errors originate.\\

\noindent Whilst (\ref{eqn:GeneralizedBloch}) is the perhaps the most generic form of the Bloch equation,
it is not the one most commonly seen in the CASPT2 literature, which is 
\begin{equation}
(E_{0} - \mathbf{H}_{0})\mathbf{\Omega} \boldsymbol{\Psi}_{0} =
 \mathbf{Q}\mathbf{V}\boldsymbol{\Omega}\boldsymbol{\Psi}_{0}- 
 \mathbf{Q}\boldsymbol{\Omega}\mathbf{P}\mathbf{V}\boldsymbol{\Omega}\boldsymbol{\Psi}_{0} 
\end{equation}
To obtain this expression introduce the notation
\begin{equation}
\mathbf{H}_{0}=
\begin{bmatrix}
\mathbf{H}_{PP} & \mathbf{0} \\
\mathbf{0} & \mathbf{H}_{QQ} \\
\end{bmatrix},
\text{ \ \ \ \ }
\mathbf{V} =
\begin{bmatrix}
\mathbf{0} & \mathbf{H}_{PQ} \\
\mathbf{H}_{QP} & \mathbf{0} \\
\end{bmatrix}.
\label{eqn:MatToAlgBloch}
\end{equation}
Where, 
\begin{equation}
\mathbf{H}_{0}\mathbf{\Psi}_{0} = \mathbf{E}^{(0)}\mathbf{\Psi}_{0}
\label{eqn:unperturbedHE}
\end{equation}
and 
\begin{equation}
(\mathbf{H}_{0}+\mathbf{V})\mathbf{\Psi} = (\mathbf{E}^{0}+\mathbf{E}^{'})\mathbf{\Psi}
\label{eqn:perturbedHE}
\end{equation}
Writing $\boldsymbol{\Psi}$ as $\boldsymbol{\Omega}\boldsymbol{\Psi}_{0}$, and using employing the generalized Bloch equation (\ref{eqn:GeneralizedBloch}) leads to
\begin{equation}
\boldsymbol{\Omega}(\mathbf{H}_{0}+\mathbf{V})\boldsymbol{\Omega}\mathbf{\Psi}_{0} =
\boldsymbol{\Omega}(\mathbf{E}^{0}+\mathbf{E}^{'})\boldsymbol{\Omega}\mathbf{\Psi}_{0}
\label{eqn:WWperturbedHE}
\end{equation}
and expression for $\mathbf{E}^{'}$ (for those states within the $P$-block only);
\begin{equation}
\mathbf{E}^{'} = \boldsymbol{\Omega}\mathbf{P}\mathbf{V}\boldsymbol{\Omega}\mathbf{\Psi}_{0}.
\label{eqn:EprimeGen}
\end{equation}
Similarly, it is also possible to write
\begin{equation*}
(\mathbf{H}_{0}+\mathbf{V})\boldsymbol{\Omega}\mathbf{\Psi}_{0} =
(\mathbf{E}^{0}+\mathbf{E}^{'})\boldsymbol{\Omega}\mathbf{\Psi}_{0}
\end{equation*}
\begin{equation}
\rightarrow
(\mathbf{E}^{0}-\mathbf{H}_{0})\boldsymbol{\Omega}\mathbf{\Psi}_{0} =
 (\mathbf{V}-\mathbf{E}^{'})\boldsymbol{\Omega}\mathbf{\Psi}_{0} 
\label{eqn:WperturbedHE}
\end{equation}
Using the expression for $\mathbf{E}^{'}$ in  (\ref{eqn:EprimeGen}) gives
\begin{equation}
(\mathbf{E}^{0}-\mathbf{H}_{0})\boldsymbol{\Omega}\mathbf{\Psi}_{0} =
\mathbf{V}\boldsymbol{\Omega}\mathbf{\Psi}_{0} - 
\boldsymbol{\Omega}\mathbf{P}\mathbf{V}\boldsymbol{\Omega}\mathbf{\Psi}_{0}.
\label{eqn:BGenIntermediate}
\end{equation}
The RHS can now be multiplied by $(\mathbf{P}+\mathbf{Q})$,  and upon noting that
\begin{equation*}
\mathbf{P}\mathbf{V}\boldsymbol{\Omega}\mathbf{\Psi}_{0} = \mathbf{P}\boldsymbol{\Omega}\mathbf{P}\mathbf{V}\boldsymbol{\Omega}\mathbf{\Psi}_{0}.
\end{equation*}
this term can be cancelled, leaving
\begin{equation}
(\mathbf{E}^{0}-\mathbf{H}_{0})\boldsymbol{\Omega}\mathbf{\Psi}_{0} =
\mathbf{Q}\mathbf{V}\boldsymbol{\Omega}\mathbf{\Psi}_{0} - 
\mathbf{Q}\boldsymbol{\Omega}\mathbf{P}\mathbf{V}\boldsymbol{\Omega}\mathbf{\Psi}_{0},
\label{eqn:BGenMSCASPT2}
\end{equation}
which is the form in which the Bloch equation appears much of the perturbation theory literature.\\

\noindent It is important to note that whilst (\ref{eqn:BGenMSCASPT2}) is the principal equation,
for it to hold it (given the above definitions) it requires that $\mathbf{T}$ is such that
(\ref{eqn:HQP}) vanishes. Often, approximations are used in the definition of the matrix components
which appear in (\ref{eqn:HQP}), and how these approximations impact the accuracy of methods based on
(\ref{eqn:BGenMSCASPT2}) is an important topic which we return to in due course.

\section{ Multistate CASTP2 and Extended Multistate CASPT2 }

\noindent Multistate methods generally start from the effective Bloch Hamiltonian defined in 
(\ref{eqn:effective_Bloch}) as 
\begin{equation}
\hat{H}^{Bloch} = \hat{P}\hat{H}\hat{\Omega}\hat{P}
\label{eqn:effective_Bloch_opform}
\end{equation}
as in the perturbation theory for the single state case the wave operator, $\hat{\Omega}$, is expanded as a series 
of which we take the only the first two terms
\begin{equation}
\hat{\Omega} =\hat{\Omega} =  1 + \hat{\Omega}^{sd}+ \hat{\Omega}^{qt}+ 
\end{equation}
\begin{equation}
\hat{H}^{Bloch,2} = \hat{P}\hat{H}\hat{P} +  \hat{P}\hat{H}\hat{\Omega}^{sd}\hat{P}.
\label{eqn:effective_Bloch_opform_secondorder}
\end{equation}
The eigenvalues of this effective Hamiltonian are the energies of the perturbed wavefunction.\\

\noindent To reconnect with the previous discussion around (\ref{eqn:P_on_EH_ms_nondiag}) this may be 
be written out with the summations made explicit,
\begin{equation}
\hat{H}^{Bloch,2} = 
\sum_{mn}|m\rangle\langle m | \hat{H} |n \rangle\langle n|+
\sum_{mn}|m\rangle\langle m | \hat{H}\hat{\Omega}^{sd}_{r} |n \rangle\langle n|
\label{eqn:effective_Bloch_summation_explicit}
\end{equation}
Hereafter, $ \hat{H}^{eff} =  \hat{H}^{Bloch,2} $, unless otherwise stated. Using the definitions 
\begin{equation}
|\Psi_{i}\rangle = \sum_{l}^{l \in \mathrm{p}} X_{l}^{i} | l \rangle
\text{\ \ \ and \ \ \ }
\hat{\Omega}^{sd}| k \rangle  = \sum_{r} \hat{\Omega}_{k} = \Bigg{[}\sum_{r}^{r \in q^{sd}} T^{k}_{r} |r\rangle\langle k |\Bigg{]} |  k \rangle,
\end{equation}
an element of the effective Hamiltonian, $H_{ij}^{eff}$, may be written,
\begin{equation*}
\langle \Psi_{i} | \hat{H}^{Bloch,2} | \Psi_{j} \rangle =
\end{equation*}
\begin{equation}
\sum_{mn}^{\in \mathbf{p}}
X^{i\dagger}_{m} \langle m | \hat{H} |n \rangle  X^{j}_{n}
+\sum_{mnkl}^{\in \mathbf{p} }\sum_{r}^{\in \mathrm{q}^{sd}}
X^{i\dagger}_{m}\langle m |
\hat{H} T^{l}_{r}
|r \rangle\langle n | n \rangle  X^{j}_{n}
\label{eqn:effective_Bloch_summation_explicit}
\end{equation}
The above assumes that the members of p are orthogonal; $\langle n | k \rangle X^{i}_{k} = X^{i}_{n}\delta_{nk}$. \\ 

\noindent Typically, members, $\{|p\rangle \}$, of subspace $\mathbf{p}$ are chosen such that they are 
eigenvectors of $\hat{H}_{0}$, i.e., $\langle m | n \rangle X^{i}_{n} = \delta_{mn}$,
which simplifies the above expression further still; 
\begin{equation}
H^{eff}_{ij} = 
\langle i | \hat{H} | j \rangle
+\sum_{r}^{\in \mathrm{q}^{sd}}
\langle i | \hat{H} T^{j}_{r} |r \rangle\langle j | j \rangle
\label{eqn:effective_Bloch_summation_explicit_diag}
\end{equation}
The diagonal elements are the single state CASPT2 energies, and have contributions from both terms.
The off diagonal elements $(i \neq j)$ only have contributions from the second term, 
and are zero in the absence of the perturbation. \\

\noindent To examine the interactions between different states more closely it is useful to partition the Hamiltonian into blocks;
\begin{equation*}
\hat{H} = 
\hat{P}\hat{H}\hat{P}+ \hat{Q}\hat{H}\hat{Q}+ 
\hat{P}\hat{H}\hat{Q}+ \hat{Q}\hat{H}\hat{P}.
\end{equation*}
\noindent Two of the most common definitions and requirements in perturbation theories are
\begin{equation*}
\hat{H} = \hat{H}^{0}+\hat{V} 
\text{ \ \ \ and \ \ \ }
\hat{H}_{0} |m \rangle = \epsilon^{0}_{m}|m\rangle \text{ \ \ } m \in \mathrm{p} 
\end{equation*}
which when combined with the third and fourth requirements gives
\begin{equation}
\langle m| \hat{V} |n \rangle = 0 
\text{ \ \ and  \ \ }
\langle m| \hat{H} |r \rangle = 0 \text{ \ \ } \forall m,n \in \mathrm{p} \text{,\ \ } \forall r \in \mathrm{q}^{sd} 
\label{eqn:V_H_are_same_def}
\end{equation}
suggests the following definitions of $\hat{H}^{0}$ and $\hat{V}$,
\begin{equation}
\hat{H}^{0}  = \hat{P}\hat{H}\hat{P}+ \hat{Q}\hat{H}\hat{Q}
\text{ \ \ \ and \ \ \ } \hat{V}  =  \hat{P}\hat{H}\hat{Q}+ \hat{Q}\hat{H}\hat{P}
\label{eqn:H_V_definition}
\end{equation}
which may be used to rewrite the expression for $H^{eff}_{ij}$ in the perhaps more familiar form
\begin{equation}
H^{eff}_{ij} =  
\langle i | \hat{H}_{0} | j \rangle
+\sum_{mn}^{\in \mathrm{p} }\sum_{r}^{\in \mathrm{q}^{sd}}
\langle i | \hat{V} T^{j}_{r} |r \rangle\langle j | j \rangle.
\label{eqn:effective_Bloch_H_plus_V}
\end{equation}
In the single state case, the second term of (\ref{eqn:effective_Bloch_H_plus_V}) reduces to the
expression for the second order energy found in (\ref{eqn:single_state_ptE_second_order}). Furthermore, by comparing 
the definitions in (\ref{eqn:H_V_definition}) and that in (\ref{eqn:MatToAlgBloch}), the
connection between this expression and the generalized Bloch equation will hopefully become 
more apparent.\\

\section {MRPT2 energy derivatives}
\noindent The conditions specified in (\ref{eqn:V_H_are_same_def}) clearly pertain to 
a very specific situation, but are still often employed as part of a method, albeit an 
indirect one, of expanding the basis used to describe the wavefunction.\\

\noindent This is particularly useful when calculating the linear response of the energy to the
perturbation of a parameter about zero, e.g., 
\begin{equation}
\frac{ \delta E }{ \delta \mathbf{R} } \Bigg{|}_{\mathbf{\mathbf{R}=0}}
\text{\ \ where \ \ }
\hat{H} = \hat{H}^{0}[\mathbf{R}] + \hat{V}[\mathbf{R}] 
\text{\ \ and \ \ }
\hat{V}[\mathbf{R} = 0 ]  = 0 
\end{equation}
Where $\mathbf{R} = 0$ is just some equilibrium value for $\mathbf{R}$, i.e., the derivative is begin taken
about the point where the off diagonal blocks of the Hamiltonian are zero $\hat{H}_{PQ} = 0$. \\

\noindent  In the many cases, notably where $\mathbf{R}$ is a nuclear coordinate,
these gradients can be strongly influenced by the correlation with highly energetic orbitals not included
within the active space, and MS-CASPT2 is a way of taking this into account.
Provided the states in the model space are well separated the interaction between them due
to the perturbation is often small enough, e.g., smaller than the sum total of their 
interaction with all states in the external space $\mathrm{q}$, to be safely neglected.\\

\noindent Unfortunately, taking derivatives
of the effective Hamiltonian with respect to a perturbation parameter is not
straight forward. Consider the derivative of (\ref{eqn:effective_Bloch_summation_explicit})
\begin{equation}
\frac{\delta H^{eff}_{ij}} {\delta \mathbf{R} } =
\frac{\delta } {\delta \mathbf{R} } \Bigg{[} \sum_{mn}
 X_{m}^{i\dagger}\langle m | (\hat{H}^{0} + \hat{V}) | n \rangle X_{n}^{j} \Bigg {]}
\frac{\delta } {\delta \mathbf{R} }
+ \Bigg{[}  
\sum_{mn}^{\in \mathrm{p} }\sum_{r}^{\in \mathrm{q}^{sd}}
 X_{m}^{i\dagger}
\langle i | (\hat{H}^{0}+\hat{V}) T^{n}_{r} |r \rangle\langle n | n \rangle
 X_{n}^{j\dagger}
 \Bigg {]}.
\label{eqn:effective_Bloch_summation_derivative}
\end{equation}
The dependence of $T^{j}_{r}$ on $\mathbf{R}$ is complicated; if $|j\rangle$ is a CASSCF wavefunction, then $T^{j}_{r}$ is
dependent on the ci-coefficients and orbital coefficients used to define $|j\rangle$, which are dependent on $\hat{H}$,
which is dependent on $\mathbf{R}$. This dependence of $T^{j}_{r}$ on the $j$ prevents the Hellman-Feynman theorem being used. 
An alternative might be to use the chain rule, and determine the derivatives of the ci and
orbital coefficients with respect to $\mathbf{R}$, but this is not feasible in terms of computational cost.
Instead a Lagrangian approach is adopted, which incorporates all the various constraints associated with the optimization 
of the T amplitudes, ci and orbital coefficients.\\

\noindent Before proceeding it is worth noting that any resulting theory should be invariant with 
respect to transformation in the reference space. Previously, it was stated that $\mathbf{X}_{n}^{j}$ 
can effectively be set to $\delta_{nj}$ by requiring that the model space is comprised of eigenvectors
of the zeroth order Hamiltonian $\hat{H}^{0}$. However, this is somewhat problematic when dealing with 
degeneracies; the eigenstates are not uniquely defined. For example, in the case of a conical intersection two states are
degenerate, but may have very different nuclear energy gradients. If these gradients are to
be consistently defined for the two states there cannot be arbitrary rotations occurring between the
different eigenvectors.\\

\noindent Extended multistate CASPT2 (XMS-CASPT2) handles this issue by defining the zeroth order Hamiltonian as
\begin{equation}
\hat{H}_{0,XMS} = \hat{P}\hat{f}\hat{P} +  \hat{Q}\hat{f}\hat{Q},
\end{equation}
where $\hat{f}$ is the state averaged Fock operator defined by
\begin{equation}
\hat{f} = \sum_{cd}f_{cd} = \sum_{cd}
\hat{a}^{\dagger}_{c}\hat{a}_{d}
\Bigg{[} h_{cd} 
+ \sum_{ab}d_{ab}
\frac{1}{2}( 2J^{ij}_{ab}-K^{ij}_{ab})  \Bigg{]}
\end{equation}
where $a$,$b$,$c$ and $d$ are molecular orbital indices,
$J^{cd}_{ab} = (ij|ab)$ and $K^{cd}_{ab} = (ca|db)$ are two electron integrals, and $d_{ab}$ are elements of the reduced, one-electron,
state-averaged density matrix. The states $\{|p\rangle\}$ are unitary transformed into a set $\{|\tilde{p}\rangle\}$, 
which are eigenvectors of $\hat{H}_{0,XMS}$ with eigenvalues $\tilde{\epsilon}_{p}$;
\begin{equation}
|\tilde{p} = \sum_{l}|l\rangle U_{lp}
\end{equation}
The state averaging ensures that the elements $f_{cd}$, and their derivative with respect to any perturbing 
parameter, are invariant under rotations between states. This will result in a consistent definition of 
the energy derivatives, even at conical intersections.\\

\noindent Another advantage is that choosing the zeroth order energies $\epsilon^{0}_{i}$ 
to be the eigenvalues of the state averaged Fock operator greatly reduces the chances 
of a zero occurring in the denominator of the expression (\ref{eqn:T_update}) used to calculate 
the T-amplitudes. One added complexity in XMS-CASPT2 is that the eigenvectors of $\hat{f}^{sa}$, defined by coefficients $X_{n}^{j}$, 
have an implicit dependence on $\mathbf{R}$. This can be handled by adding another constraint to the Lagrangian,
but must be borne in mind. Hereafter, the $XMS$ subscript on $\hat{H}_{0,XMS}$ will be omitted.

%\noindent Before proceeding to the derivation of the Lagrangian, it is worth mentioning
%that a significant case in which the requirements in (\ref{eqn:V_H_are_same_def}),
%are unreasonable is when $\mathrm{p}$ is comprised of a number of degenerate states
%within a spin multiplet, and $\hat{V}$ is an external magnetic field. 

%(\ref{eqn:Q_on_both_sides_singlestate}),
%If there is more than one state in  
%\begin{equation*}
%  \sum_{kl}X^{p\dagger}\langle m | (\epsilon_{p} - \hat{H}_{0}) | l \rangle X_{l}^{p}
%+ \sum_{kr}X^{p\dagger}\langle m | (\epsilon_{p} - \hat{H}_{0}) | r \rangle T_{r}^{p}
%\end{equation*}
